<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sharjah Auto Route – Smart Bins (Firestore)</title>

  <!-- Leaflet & Routing styles -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.css"/>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .panel {
      position: absolute; z-index: 1000; left: 10px; top: 10px;
      background: #fff; border-radius: 10px; padding: 10px 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.18); font: 14px/1.25 system-ui, Arial;
      width: 260px;
    }
    .panel h3 { margin: 0 0 8px; font-size: 16px; }
    .panel label { display: block; margin: 8px 0 4px; font-weight: 600; }
    .panel input[type="number"] { width: 90px; }
    .panel button {
      margin-top: 8px; padding: 7px 10px; border-radius: 8px; border: 1px solid #e5e7eb;
      background: #2563eb; color: #fff; cursor: pointer;
    }
    .tag { display:inline-block; padding:2px 6px; border-radius:6px; font-size:12px; background:#eef2ff; color:#3730a3; margin-left:6px; }
    .leaflet-routing-container { max-height: 35%; overflow: auto; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Controls -->
  <div class="panel" id="ui">
    <h3>Auto Route Options</h3>
    <div><b>Start:</b> Sharjah Municipality <span class="tag">Depot</span></div>
    <label for="minFill">Min fill % to include</label>
    <input id="minFill" type="number" min="0" max="100" value="40">
    <button id="buildBtn">Build Route</button>
    <div id="status" style="margin-top:8px;color:#6b7280;font-size:12px;"></div>
  </div>

  <!-- Leaflet & Routing scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>

  <!-- Firebase (modular v9) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ===== 1) FIREBASE CONFIG — replace with your own from Firebase Console > Project Settings > Your Web App
    const firebaseConfig = {
      apiKey: "AIzaSyCa__qGv-VmW5etGt1QRC5McJqxE_xoWa0",
      authDomain: "bingenius-5bf69.firebaseapp.com",
      projectId: "bingenius-5bf69",
    };

    // ===== 2) INIT FIREBASE & DB
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== 3) MAP
    const DEPOT = { name: 'Sharjah Municipality HQ', lat: 25.35694, lng: 55.40139 };

    const map = L.map('map').setView([25.33, 55.43], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    L.marker([DEPOT.lat, DEPOT.lng], { title: DEPOT.name })
      .addTo(map)
      .bindPopup(`<b>${DEPOT.name}</b><br>Route origin (depot).`);

    let routingControl = null;
    const status = document.getElementById('status');

    function makeRouter(serviceUrl) {
      return L.Routing.osrmv1({ serviceUrl });
    }
    const ROUTERS = [
      'https://router.project-osrm.org/route/v1',
      'https://routing.openstreetmap.de/routed-car/route/v1'
    ];

    async function fetchBins() {
      status.textContent = 'Loading bins from Firestore…';
      const binsCol = collection(db, 'bins');
      // order by fill desc so markers render in that order (not required)
      const q = query(binsCol, orderBy('fill', 'desc'));
      const snap = await getDocs(q);
      const bins = [];
      snap.forEach(doc => {
        const d = doc.data();
        if (typeof d.lat === 'number' && typeof d.lng === 'number') {
          bins.push({
            id: doc.id,
            name: d.name ?? 'Bin',
            lat: d.lat,
            lng: d.lng,
            fill: typeof d.fill === 'number' ? d.fill : 0,
            isArduino: !!d.isArduino
          });
        }
      });
      status.textContent = `Loaded ${bins.length} bin(s).`;
      return bins;
    }

    function showMarkers(bins) {
      bins.forEach(b => {
        const label = b.isArduino ? `${b.name} <span class="tag">Arduino</span>` : b.name;
        L.marker([b.lat, b.lng], { title: b.name })
          .addTo(map)
          .bindPopup(`<b>${label}</b><br>Fill: ${b.fill}%`);
      });
    }

    function buildRouteFrom(bins, routerIndex = 0) {
      const minFill = Number(document.getElementById('minFill').value) || 0;

      const targets = bins
        .filter(b => b.fill >= minFill)
        .sort((a, b) => b.fill - a.fill); // fullest first

      if (targets.length === 0) {
        status.textContent = 'No bins meet the minimum fill threshold.';
        alert('No bins meet the minimum fill threshold.');
        return;
      }

      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
      }

      const waypoints = [
        L.latLng(DEPOT.lat, DEPOT.lng),
        ...targets.map(b => L.latLng(b.lat, b.lng))
      ];

      status.textContent = 'Requesting route…';
      routingControl = L.Routing.control({
        waypoints,
        router: makeRouter(ROUTERS[routerIndex]),
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        routeWhileDragging: false,
        show: true,
        lineOptions: { addWaypoints: false },
        createMarker: function(i, wp) {
          if (i === 0) return L.marker(wp.latLng).bindPopup(`<b>${DEPOT.name}</b><br>Start`);
          const bin = targets[i - 1];
          const ar = bin.isArduino ? ' <span class="tag">Arduino</span>' : '';
          return L.marker(wp.latLng).bindPopup(`<b>${bin.name}${ar}</b><br>Fill: ${bin.fill}%`);
        }
      })
      .on('routesfound', () => { status.textContent = 'Route ready.'; })
      .on('routingerror', () => {
        if (routerIndex + 1 < ROUTERS.length) {
          status.textContent = 'Primary router busy—trying fallback…';
          buildRouteFrom(bins, routerIndex + 1);
        } else {
          status.textContent = 'Routing servers busy or blocked. Try again.';
          alert('Routing server is busy or blocked. Try again in a minute.');
        }
      })
      .addTo(map);
    }

    // Load bins, show markers, build route
    const allBins = await fetchBins();
    showMarkers(allBins);

    document.getElementById('buildBtn').addEventListener('click', () => buildRouteFrom(allBins, 0));
    // Build once on load
    buildRouteFrom(allBins, 0);

    // Don’t drag map when using the panel
    L.DomEvent.disableClickPropagation(document.getElementById('ui'));
  </script>
</body>
</html>
